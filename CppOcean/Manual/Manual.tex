\documentclass[12pt]{amsart}
\usepackage{amsfonts, amsmath, latexsym, epsfig}
\usepackage{amssymb}
\usepackage{epsf}
\usepackage{url}


\newcommand{\RR}{\ensuremath{\mathbb{R}}}
\newcommand{\NN}{\ensuremath{\mathbb{N}}}
\newcommand{\QQ}{\ensuremath{\mathbb{Q}}}
\newcommand{\CC}{\ensuremath{\mathbb{C}}}
\newcommand{\ZZ}{\ensuremath{\mathbb{Z}}}
\newcommand{\TT}{\ensuremath{\mathbb{T}}}
\newtheorem{proposition}{Proposition}
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{problem}{Problem}
\newtheorem{conjecture}{Conjecture}
\newtheorem{claim}{Claim}
\newtheorem{remark}{Remark}
\newtheorem{definition}{Definition}
%\newcommand{\qed}{\hfill $\Box$ }
%\newcommand{\proof}{\noindent{\bf Proof.}\ \ }
\def\QuotS#1#2{\leavevmode\kern-.0em\raise.2ex\hbox{$#1$}\kern-.1em/\kern-.1em\lower.25ex\hbox{$#2$}}


%\usepackage{vmargin}
%\setpapersize{custom}{21cm}{29.7cm}
%\setmarginsrb{1.7cm}{1cm}{1.7cm}{3.5cm}{0pt}{0pt}{0pt}{0pt}
%marge gauche, marge haut, marge droite, marge bas.
\urlstyle{sf}
%\author{Mathieu DUTOUR SIKIRI\'C}

\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Sym}{Sym}


\begin{document}

\author{Mathieu Dutour Sikiri\'c}
\address{Mathieu Dutour Sikiri\'c, Rudjer Boskovi\'c Institute, Bijenicka 54, 10000 Zagreb, Croatia, Fax: +385-1-468-0245}
\email{mdsikir@irb.hr}



\title{{\tt C++} - ocean}


\maketitle

\begin{abstract}
We explain here the C++ programs which are designed to work with oceanographic and meteorological data sets.
\end{abstract}

\section{Designs principles}

\begin{enumerate}
\item {\bf Namelist}: Namelists are used by many other oceanographic and meteorological programs (WWM, COSMO, WAM, etc.) and so the same file format is used by the C++ programs.
\item {\bf No intermediate files}: It is common to have programs converting from format A to B and then using it. The problem of that approach is that the files in geoscience are usually big and this duplication is pointless.
\item {\bf Access to all data files}: Interface have been designed for direct access to all kinds of data files in NETCDF and GRIB formats. Other file format will be added in the future if needed.
\item {\bf No distinction between structured and unstructured}: Models come in all kind of shapes and the goal of the program is to accomodate them all.
\item {\bf Common interfaces}: Same input structure between different programs
\item {\bf Use NCL for plots}: NCL is probably the best language for making 2D graphics in geoscience and offers the largest set of possibilities. NCL is called by scripts written from the C++ program.
\end{enumerate}






\section{Model data input}

The supported models are: {\tt WWM}, {\tt WAM}, {\tt COSMO}, {\tt WW3}, {\tt ROMS}, {\tt GRIB\_ECMWF}, {\tt GRIB\_GFS}, {\tt GRIB\_COSMO}, {\tt GRIB\_DWD}.
The relevant values in the file are {\tt GridFile}, {\tt HisPrefix} and {\tt MODELNAME}.



Currently the code supports the following models:
\begin{enumerate}
\item {\tt WWM}: The Wind Wave Model III for wave modelling. 3 formats of grids are supported at the present moment:
{\bf .gr3}, {\bf .dat} (XFN format) and {\bf .nc} (netcdf file).
Example of input file:
\begin{verbatim}
 MODELNAME = "WWM"
 GridFile = "hgrid.gr3",
 HisPrefix = "WWM_output_",
\end{verbatim}
or 
\begin{verbatim}
 MODELNAME = "WWM"
 GridFile = "system.dat",
 HisPrefix = "WWM_output_",
\end{verbatim}
or
\begin{verbatim}
 MODELNAME = "WWM"
 GridFile = "WWM_output_0001.nc",
 HisPrefix = "WWM_output_",
\end{verbatim}
\item {\tt WAM}: Both in its structured and unstructured versions.
\begin{verbatim}
 MODELNAME = "WAM"
 GridFile = "WAM_output_0001.nc",
 HisPrefix = "WWM_output_",
\end{verbatim}
(the first history file contains the grid)
\item {\tt WW3}: The Wavewatch III model both in its structured and unstructured versions.
\begin{verbatim}
 MODELNAME = "WW3"
 GridFile = "WAM_output_0001.nc",
 HisPrefix = "WWM_output_",
\end{verbatim}
\item {\tt COSMO}: The atmospheric model and the netcdf output from the coupled version with ROMS and WAM.
\begin{verbatim}
 MODELNAME = "COSMO"
 GridFile = "COSMO_output_0001.nc",
 HisPrefix = "COSMO_output_",
\end{verbatim}
(the first history file contains the grid)
\item {\tt ROMS} (Just {\tt ROMS} or {\tt ROMS\_IVICA}): The structured model for data output.
\begin{verbatim}
 MODELNAME = "ROMS"
 GridFile = "roms_grid.nc",
 HisPrefix = "ROMS_output_",
\end{verbatim}
{\tt ROMS} is for normal ROMS output, {\tt ROMS\_output\_0001.nc}, etc. {\tt ROMS\_IVICA} is for files by date {\tt ROMS\_output\_20140101.nc}, etc.
\item {\tt GRIB} (variant ECMWF, DWD, COSMO, GFS): The GRIB files are essentially standardized but there are small differences between DWD, ECMWF, COSMO and GFS. Also the grid is part of the GRIB file so there is no need for GribFile here.
\begin{verbatim}
 MODELNAME = "GRIB_ECMWF", 
 HisPrefix = "/home/mathieu/Forecast_input/ECMWF_coarse/", 
\end{verbatim}
The {\tt GridFile} does not need to be set because the grid is part of the data itself.

\end{enumerate}


\section{Time and variables}

The times are enetered just as in {\tt WWM}.
Example:
\begin{verbatim}
 BEGTC = "20150410.000000",
 ENDTC = "20150421.120000",
 DELTC = 7200, 
 UNITC = "SEC", 
\end{verbatim}

The variables that are available for use and plots are:
\begin{enumerate}
\item {\bf WIND10}: 10m wind speed (as a vector with Uwind, Vwind components)
\item {\bf SurfCurr}: Surface currents
\item {\bf Hwave}: Significant Wave height
\item {\bf WINDMAG}: Wind magnitude
\item {\bf TempSurf}: Surface sea temperature
\item {\bf SaltSurf}: Surface sea salinity
\item {\bf AIRT2}: 2m air temperature
\item {\bf Rh2}: 2m air humidity
\item {\bf ZetaOcean}: free surface elevation
\item {\bf MwaveFreq}: Mean wave frequency
\item {\bf PwaveFreq}: Peak wave frequency
\item {\bf AIRD}: Surface air density
\item {\bf CdWave}: drag coefficient from the wave model
\item {\bf AlphaWave}: Charnock coefficient from the wave model
\item {\bf rain}: rainfall rate
\item {\bf swrad}: shortwave radiation
\item {\bf lwrad}: longwave radiation
\item {\bf latent}: latent heat flux
\item {\bf sensible}: sensible heat flux
\item {\bf shflux}: surface heat flux
\item {\bf ssflux}: surface salinity flux (ah ah)
\item {\bf evaporation}: evaporation
\item {\bf MwavePer}: mean wave period
\item {\bf PwavePer}: Peak wave period
\item {\bf SurfPres}: surface air pressure.
\end{enumerate}








\section{Programs available}

The following programs are available:
\begin{enumerate}
\item {\bf PLOT\_result}: It is for plotting data files.
\item {\bf PLOT\_diff\_results}: It is for plotting the difference of model results (models have to be identical and share the same grid.
\item {\bf AltimeterComparison}: This is for comparison of model results with altimeter
\item {\bf CREATE\_sflux}: This is for creating sflux files from finite difference model usable by the SELFE model.
\item {\bf INTERPOL\_field}: This is for merging several different forcing files and creating an input file for the WWM model.
\end{enumerate}
Other programs can be written by basing oneself on this architecture.



\subsection{PLOT\_result and PLOT\_diff\_results}

The {\tt PLOT\_result} and {\tt PLOT\_diff\_results} programs are designed to plot model output and plot it. The difference is that {\tt PLOT\_result} is for single model output, while {\tt PLOT\_diff\_results} is for finding the difference between two model outputs.

A minimal example file for {\tt PLOT\_results} is given below:
\begin{verbatim}
&PROC
 MODELNAME = "GRIB_DWD", 
 BEGTC = "20150410.000000",
 ENDTC = "20150421.120000",
 DELTC = 7200, 
 UNITC = "SEC", 
 HisPrefix = "/home/mathieu/Forecast_input/DWD/", 
 PicPrefix = "/home/mathieu/Forecast_input/DWD/PlotWind/", 
 Extension="png",
/

&VARS
 WIND10 = F, 
 WINDMAG = T, 
/
\end{verbatim}
It means that model output of DWD from the directory {\tt /home/mathieu/Forecast\_input/DWD/} are being plotted every 2 hours and that the output directory is {\tt /home/mathieu/Forecast\_input/DWD/PlotWind/}. The extension of the images is {\tt png}.

Variable that is plotted is {\tt WINDMAG} only as selected by the {\tt T/F} switches. If a variable is not put then it is false by default.

A small example input file for {\tt PLOT\_diff\_results} is the follwoing:
\begin{verbatim}
&PROC
 MODELNAME = "WAM", 
 BEGTC = "20110915.000000", 
 DELTC = 3600, 
 UNITC = "SEC", 
 ENDTC = "20110925.000000", 
 HisPrefix1 = "WAM_output_", 
 Name1 = "3 models",
 HisPrefix2 = "../RUN_cosmowam/WAM_output_", 
 Name2 = "2 models",
 PicPrefix = "Pictures/WAM_Hwave_coupled_uncoupled/",
 Extension= "png",
 KeepNC_NCL = T,
/

&VARS
 WIND10 = F, 
 UVsurf = F, 
 Hwave = T
/
\end{verbatim}


\subsubsection{Nature query option}
We have following possible queries for the {\tt PLOT\_result}:
\begin{verbatim}
ListNatureQuery = 'instant', 'average', 'swathMax', 'swathMin'
TimeFrameDay = 30
\end{verbatim}
By default only 'instant' is selected and value of the field at the precise time are plot.
If 'average' is selected then we have the plots of average value of the field for the period $[t, t+ T]$ with $t$ the time just as for instant field and $T$ the value of {\tt TimeFrameDay}. So a $T=30$ corresponds to monthly averages.
If 'swathMax' or 'swathMin' is selected then the maximum and minimum values over the time intervals $[t, t+T]$ are also plot.

Above options are also possible for {\tt PLOT\_diff\_result}. But two more options 'MaxDiff' and 'MinDiff' are also possible. MaxDiff/MinDiff plots the maximum/minimum difference over the interval $[t, t+T]$. This is different from swathMax/swathMin which would plot the difference between the maximum over the interval of the models.

\subsubsection{Colorbar selections}
We have following options for the colormaps:
\begin{verbatim}
DoColorBar = T
BoundSingle_var = Hwave, TM02
BoundSingle_min = 0,   5
BoundSingle_max = 4,   20
BoundDiff_var = Hwave, TM02
BoundDiff_min = -0.2, -2
BoundDiff_max = 0.2,  2
VariableColormap = F
\end{verbatim}
By default a fixed colorbar is used for the plots. The range is fixed in the code for each variable and is generally reasonable. If you want to change the minimum/maximum, then you need to use {\tt BoundSingle\_var/min/max} for {\tt PLOT\_result} and {\tt BoundDiff\_var/min/max} for {\tt PLOT\_diff\_results}.

If you want a colorbar that varies from one time to the next then use {\tt VariableColormap} and the maximum and minimum of the field will be used. If you do not want and colorbar to plotted, then select {\tt DoColorBar = F}.




\subsubsection{Miscelaneous options}

Following options are available in the {\tt PLOT} section:
\begin{enumerate}
\item {\tt DoTitle} (logical): draw the title of the figures. Default is true.
\item {\tt PlotDepth} (logical): draw the bathymetry of the domain if available. Default is true.
\item {\tt PrintMMA} (logical): Print the minimum / maximum / average of the fields considered. Default is false
\item {\tt LocateMM} (logical): locate the position of maximum and minimum values. Default is false.
\item {\tt FillLand} (logical): Fill the land by using the geographic database of NCL.
\item {\tt cnFillMode} (string): Method used for drawing. Available methods are:
  \begin{enumerate}
  \item ``RasterFill'': It plots values of the cell corresponding to the field considered.
  \item ``AreaFill'': It plots smoothed values of the fields
  \item ``CellFill'': It is a smoothed field (only for finite difference)
  \end{enumerate}
  Defaut is RasterFill.
\end{enumerate}

It is also possible to plot values of field in a fixed LON/LAT ranges. Relevant options are the following:
\begin{enumerate}
\item {\tt DoMain} (logical): draw the grid of the model. Default is true.
\item {\tt ListFrameMinLon / ListFrameMinLat / ListFrameMaxLon / ListFrameMaxLat}: The list of values of the fields considered.
\end{enumerate}










\subsection{AltimeterComparison}

The data set used is the one from IFREMER. It needs first to be downloaded.
First one needs to set the environment variable {\tt ALTIMETER\_DIRECTORY}
as in for example
\begin{verbatim}
export ALTIMETER_DIRECTORY=/home/mathieu/Altimeter/
\end{verbatim}
Then one has to download the data file with the perlscript {\bf DownloadAltimeterIfremer}.

See below an example of nml files
\begin{verbatim}
&PROC
 MODELNAME = "COSMO",
 GridFile = "COSMO_output_0001.nc",
 HisPrefix = "COSMO_output_",
 PicPrefix = "./AltimeterStat/"
 Extension="png",
 KeepNC_NCL = T,
 /

&SELECT
 GEOSELECTION = 2,
 MinLON = -7, 
 MaxLON = 37, 
 MinLAT = 30, 
 MaxLAT = 46
 LONPOLY = 14, -6, -6, 40, 40, 28
 LATPOLY = 49, 39, 26, 29, 39, 39
 MinWIND = 0
 MaxWIND = 300
 MinHS = 0 
 MaxHS = 998
 BEGTC = 20101101.000000
 ENDTC = 20101231.000000
 MinimalTrackSize=30,
 EliminationShortTrack = F,
 DoTrackSmoothing = F,
 /

&PROCESS
 USE_CORRECTED = T
 DO_WNDMAG = T
 DO_HS = T
 DO_STAT = T
 DO_NCOUT = T
 DO_TXTRAW = F
 DO_SCATTERPLOT = T,
 PLOT_TRACKS = T,
 PLOT_ALL_TRACKS = T,
 DO_SAVE_TXT = F,
 SPATIALAVER = F
/
\end{verbatim}
The section {\tt PROC} is standard for the model input. Also added is the Prefix for the pictures, their extension and whether we keep the ncl files for further work.

The section {\tt SELECT} contains information on the processing done:
\begin{enumerate}
\item {\tt GEOSELECTION} is for geographical selection of the zone of interest. GEOSELECTION=1 means using MinLon, MinLat, MaxLon, MaxLat for the selection. GEOSELECTION=2 means using LONPOLY/LATPOLY that defines a polygon.
\item {\tt MinWind, MaxWind} is for thresholding the wind values.
\item {\tt MinHS, MaxHS} is the same for significant wave height.
\item {\tt BEGTC, ENDTC} is for specifying the period of interest.
\item {\tt AllowedSatellites} is for selecting the satellites of interest. If not then all satellites are used.
\item {\tt EliminationShortTrack} is a logical for whether we eliminates the short tracks and {\tt MinimalTrackSize} is the minimal allowed track size.
\item {\tt DoTrackSmoothing} is for whether we smooth the tracks to the length scale of the models.
\item {\tt DoMinDistCoast} is for whether we filter the tracks by the distance to the coast. {\tt MinDistCoastKM} is the minimal distance to the coast that is specified. Also needed is the {\tt LonLatDiscFile} for specifying the longitude/latitude of the coast.
\end{enumerate}

The section {\tt PROCESS} specifies what will be done with the data:
\begin{enumerate}
\item {\tt DO\_WNDMAG}: specifies whether we compare wind speed or not.
\item {\tt DO\_HS}: specifies whether we compare significant wave height or not.
\item {\tt DO\_STAT}: specifies whether we do raw statistics comparison (Mean Error, Root Mean Square Error, etc.). It is the cheapest possible comparison.
\item {\tt DO\_SCATTERPLOT}: specifies whether we do scatter plot of the data or not.
\item {\tt USE\_CORRECTED}: specifies whether we use corrected data from the altimeter or not.
\item {\tt PLOT\_ALL\_TRACKS}: specified whether we plot all tracks used in the geographical domain.
\item {\tt PLOT\_TRACKS}: We can plot the model and the altimeter interpolation. {\tt MinEntryTrackPlot} specifies the minimal length for the plot to be made.
\end{enumerate}


\subsection{CREATE\_sflux}

This program is for creating sflux files that can be used by the SELFE program.
\begin{verbatim}
&PROC
 MODELNAME = "GRIB_ECMWF", 
 BEGTC = "20150410.000000",
 ENDTC = "20150421.120000",
 DELTC = 21600, 
 UNITC = "SEC", 
 HisPrefix = "/home/mathieu/Forecast_input/ECMWF_coarse/", 
 OutPrefix = "/home/mathieu/Forecast_input/ECMWF_coarse/sflux/sflux_", 
 AnalyticWind = F,
 AnalyticPRMSL = F,
 AnalyticSPFH = T,
 AnalyticSTMP = F,
/
\end{verbatim}
There is only a {\tt PROC} entry, which specifies the model that is used. {\tt DELTC} contains the interval between data output. The sflux files are daily files so DELTC must be a divisor of the length of the day.
{\tt OutPrefix} contains the prefix where the data is written.
The {\tt AnalyticWind} and others specifies whether we use analytic wind (and hence zero) if no wind is available or whether we use the data available from the model. Same for {\tt AnalyticPRMSL}, {\tt AnalyticSPFH} and {\tt AnalyticSTMP} switches.



\subsection{INTERPOL\_field}

This program is for interpolating the fields from several models, and merging them in order to
create one single series of forcing file that can be used for running WWM (only WWM right now).

An example of input file is below:
\begin{verbatim}
&INPUT
 ListMODELNAME = "GRIB_ECMWF", "GRIB_ECMWF"
 ListHisPrefix = "/home/mathieu/Forecast_input/ECMWF_coarse/", "/home/mathieu/Forecast_input/ECMWF_fine/"
 ListSpongeSize = 4, 4
 ListFatherGrid = -1, 0
/

&OUTPUT
 MODELNAME = "WWM"
 GridFile = "/home/mathieu/Forecast_input/MERGE_ECMWF/hgrid.gr3",
 HisPrefix = "File.nc",
 HisPrefixOut = "/home/mathieu/Forecast_input/MERGE_ECMWF/Forc_",
 BEGTC = "20150410.000000",
 ENDTC = "20150421.120000",
 DELTC = 3600, 
 UNITC = "SEC", 
 DEFINETC = 86400,
/

&VARS
 WIND10 = T, 
/
\end{verbatim}
The {\tt INPUT} field contains the list of model runs available. So we have a list of model names, grid files and prefix.

The {\tt OUTPUT} array contains the description of the model output. We have a {\tt MODELNAME}, {\tt GridFile} and {\tt HisPrefix} for the description of the model output. We also have a {\tt HisPRefixOut} which is the prefix of the forcing files.
Similarly, we have the {\tt BEGTC}, {\tt ENDTC} for the time frame of the data output, {\tt DELTC} for the frequency of the output and {\tt DEFINETC} for how large a single file should be.

The {\tt VARS} array contains the list of variables that are used for the output.








\end{document}
